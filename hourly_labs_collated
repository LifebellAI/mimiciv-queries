-- In this first CTE, the table mimic_hosp.labevents is first joined with icustays (so that we only get labs for patients in the icu) 
-- and then with the table mimic_hosp.d_labitems, because labitems contains the plaintext labels that correspond to the itemids
-- from the labevents table
-- In later CTE's, the individual labs have to be separated out by a WHERE clause (i.e. WHERE label = "Bicarbonate")
-- These plaintext labels were found by searching through the labitems table for the relevant plaintext
-- They should be correct on first approximation, but if we find unexpectedly sparse columns, we may want to double check these
-- Also, since the table is flat (each lab is in a separate row), part of the goal of this query is to expand each relevant lab into its own column
-- and join it with other desired labs into a single row corresponding to the truncated hour ( DATETIME_TRUNC(charttime, HOUR)) when it occurred
WITH
  labs AS (
  SELECT
    *
  FROM (
    SELECT
      *
    FROM
      `physionet-data.mimic_hosp.labevents`
    JOIN
      `physionet-data.mimic_icu.icustays`
    USING
      (subject_id,
        hadm_id))
  JOIN
    `physionet-data.mimic_hosp.d_labitems`
  USING
    (itemid)),
    
  bicarb AS (
  SELECT
    subject_id,
    hadm_id,
    DATETIME_TRUNC(charttime,
      HOUR) AS charttime,
    valuenum AS bicarbonate_value,
    valueuom AS bicarbonate_units,
    fluid AS bicarbonate_fluid
  FROM
    labs
  WHERE
    label = "Bicarbonate"),
  chloride AS (
  SELECT
    subject_id,
    hadm_id,
    DATETIME_TRUNC(charttime,
      HOUR) AS charttime,
    valuenum AS chloride_value,
    valueuom AS chloride_units,
    fluid AS chloride_fluid
  FROM
    labs
  WHERE
    label = "Chloride"),
    
  bilirubin_indirect AS (
  SELECT
    subject_id,
    hadm_id,
    DATETIME_TRUNC(charttime,
      HOUR) AS charttime,
    valuenum AS bilirubin_indirect_value,
    valueuom AS bilirubin_indirect_units,
    fluid AS bilirubin_indirect_fluid
  FROM
    labs
  WHERE
    label = "Bilirubin, Indirect"),
    
  bilirubin_direct AS (
  SELECT
    subject_id,
    hadm_id,
    DATETIME_TRUNC(charttime,
      HOUR) AS charttime,
    valuenum AS bilirubin_direct_value,
    valueuom AS bilirubin_direct_units,
    fluid AS bilirubin_direct_fluid
  FROM
    labs
  WHERE
    label = "Bilirubin, Direct"),
    
  bilirubin_total AS (
  SELECT
    subject_id,
    hadm_id,
    DATETIME_TRUNC(charttime,
      HOUR) AS charttime,
    valuenum AS bilirubin_total_value,
    valueuom AS bilirubin_total_units,
    fluid AS bilirubin_total_fluid
  FROM
    labs
  WHERE
    label = "Bilirubin, Total"),
    
  calcium AS (
  SELECT
    subject_id,
    hadm_id,
    DATETIME_TRUNC(charttime,
      HOUR) AS charttime,
    valuenum AS calcium_value,
    valueuom AS calcium_units,
    fluid AS calcium_fluid
  FROM
    labs
  WHERE
    label = "Calcium"),
    
  creatinine AS (
  SELECT
    subject_id,
    hadm_id,
    DATETIME_TRUNC(charttime,
      HOUR) AS charttime,
    valuenum AS creatinine_value,
    valueuom AS creatinine_units,
    fluid AS creatinine_fluid
  FROM
    labs
  WHERE
    label = "Creatinine"),
    
  glucose AS (
  SELECT
    subject_id,
    hadm_id,
    DATETIME_TRUNC(charttime,
      HOUR) AS charttime,
    valuenum AS glucose_value,
    valueuom AS glucose_units,
    fluid AS glucose_fluid
  FROM
    labs
  WHERE
    label = "Glucose"),
    
  lactate AS (
  SELECT
    subject_id,
    hadm_id,
    DATETIME_TRUNC(charttime,
      HOUR) AS charttime,
    valuenum AS lactate_value,
    valueuom AS lactate_units,
    fluid AS lactate_fluid
  FROM
    labs
  WHERE
    label = "Lactate"),
    
  magnesium AS (
  SELECT
    subject_id,
    hadm_id,
    DATETIME_TRUNC(charttime,
      HOUR) AS charttime,
    valuenum AS magnesium_value,
    valueuom AS magnesium_units,
    fluid AS magnesium_fluid
  FROM
    labs
  WHERE
    label = "Magnesium"),
    
  phosphate AS (
  SELECT
    subject_id,
    hadm_id,
    DATETIME_TRUNC(charttime,
      HOUR) AS charttime,
    valuenum AS phosphate_value,
    valueuom AS phosphate_units,
    fluid AS phosphate_fluid
  FROM
    labs
  WHERE
    label = "Phosphate"),
    
  potassium AS (
  SELECT
    subject_id,
    hadm_id,
    DATETIME_TRUNC(charttime,
      HOUR) AS charttime,
    valuenum AS potassium_value,
    valueuom AS potassium_units,
    fluid AS potassium_fluid
  FROM
    labs
  WHERE
    label = "Potassium"),
    
  troponin AS (
  SELECT
    subject_id,
    hadm_id,
    DATETIME_TRUNC(charttime,
      HOUR) AS charttime,
    valuenum AS troponin_value,
    valueuom AS troponin_units,
    fluid AS troponin_fluid
  FROM
    labs
  WHERE
    label = "Troponin I"),
    
  Hct AS (
  SELECT
    subject_id,
    hadm_id,
    DATETIME_TRUNC(charttime,
      HOUR) AS charttime,
    valuenum AS hct_value,
    valueuom AS hct_units,
    fluid AS hct_fluid
  FROM
    labs
  WHERE
    label = "Hematocrit"),
    
  Hgb AS (
  SELECT
    subject_id,
    hadm_id,
    DATETIME_TRUNC(charttime,
      HOUR) AS charttime,
    valuenum AS hgb_value,
    valueuom AS hgb_units,
    fluid AS hgb_fluid
  FROM
    labs
  WHERE
    label = "Hemoglobin"),
    
  PTT AS (
  SELECT
    subject_id,
    hadm_id,
    DATETIME_TRUNC(charttime,
      HOUR) AS charttime,
    valuenum AS PTT_value,
    valueuom AS PTT_units,
    fluid AS PTT_fluid
  FROM
    labs
  WHERE
    label = "PTT"),
    
  WBC AS (
  SELECT
    subject_id,
    hadm_id,
    DATETIME_TRUNC(charttime,
      HOUR) AS charttime,
    valuenum AS WBC_value,
    valueuom AS WBC_units,
    fluid AS WBC_fluid
  FROM
    labs
  WHERE
    label = "WBC Count"),
    
  Fibrinogen AS (
  SELECT
    subject_id,
    hadm_id,
    DATETIME_TRUNC(charttime,
      HOUR) AS charttime,
    valuenum AS fibrinogen_value,
    valueuom AS fibrinogen_units,
    fluid AS fibrinogen_fluid
  FROM
    labs
  WHERE
    label = "Fibrinogen"),
    
  Platelets AS (
  SELECT
    subject_id,
    hadm_id,
    DATETIME_TRUNC(charttime,
      HOUR) AS charttime,
    valuenum AS platelet_value,
    valueuom AS platelet_units,
    fluid AS platelet_fluid
  FROM
    labs
  WHERE
    label = "Platelet Count")
    
SELECT
  *
FROM
  bicarb
FULL JOIN
  chloride
USING
  (subject_id,
    hadm_id,
    charttime)
FULL JOIN
  bilirubin_indirect
USING
  (subject_id,
    hadm_id,
    charttime)
FULL JOIN
  bilirubin_direct
USING
  (subject_id,
    hadm_id,
    charttime)
FULL JOIN
  bilirubin_total
USING
  (subject_id,
    hadm_id,
    charttime)
FULL JOIN
  calcium
USING
  (subject_id,
    hadm_id,
    charttime)
FULL JOIN
  creatinine
USING
  (subject_id,
    hadm_id,
    charttime)
FULL JOIN
  glucose
USING
  (subject_id,
    hadm_id,
    charttime)
FULL JOIN
  lactate
USING
  (subject_id,
    hadm_id,
    charttime)
FULL JOIN
  magnesium
USING
  (subject_id,
    hadm_id,
    charttime)
FULL JOIN
  phosphate
USING
  (subject_id,
    hadm_id,
    charttime)
FULL JOIN
  potassium
USING
  (subject_id,
    hadm_id,
    charttime)
FULL JOIN
  troponin
USING
  (subject_id,
    hadm_id,
    charttime)
FULL JOIN
  Hct
USING
  (subject_id,
    hadm_id,
    charttime)
FULL JOIN
  Hgb
USING
  (subject_id,
    hadm_id,
    charttime)
FULL JOIN
  PTT
USING
  (subject_id,
    hadm_id,
    charttime)
FULL JOIN
  WBC
USING
  (subject_id,
    hadm_id,
    charttime)
FULL JOIN
  Fibrinogen
USING
  (subject_id,
    hadm_id,
    charttime)
FULL JOIN
  Platelets
USING
  (subject_id,
    hadm_id,
    charttime)
